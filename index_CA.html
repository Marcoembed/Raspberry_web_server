<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
    <div class="row mb-2">
        <div class="col-sm-6">
        <h1 class="m-0" id="business_name">[Loading..]</h1>
        </div><!-- /.col -->
        <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="#">Home</a></li>
            <li class="breadcrumb-item active">Dashboard</li>
        </ol>
        </div><!-- /.col -->
    </div><!-- /.row -->
    </div><!-- /.container-fluid -->
</div>
<!-- /.content-header -->

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
    <!-- Small boxes (Stat box) -->
    <div class="row">
        <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box bg-info">
            <div class="inner">
            <h3>Loading..</h3>

            <p>Worker On Site</p>
            </div>
            <div class="icon">
            <i class="ion ion-clipboard"></i>
            </div>
            <!-- <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a> -->
        </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box bg-success">
            <div class="inner">
            <h3>Loading..</h3>

            <p>Not On Site</p>
            </div>
            <div class="icon">
            <i class="ion ion-stats-bars"></i>
            </div>
            <!-- <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a> -->
        </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box bg-warning">
            <div class="inner">
            <h3>Loading..</h3>

            <p>Total Workers</p>
            </div>
            <div class="icon">
            <i class="ion ion-person-add"></i>
            </div>
            <!-- <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a> -->
        </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box bg-danger">
            <div class="inner">
            <h3>Loading..</h3>

            <p>Visitors</p>
            </div>
            <div class="icon">
            <i class="ion ion-pie-graph"></i>
            </div>
            <!-- <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a> -->
        </div>
        </div>
        <!-- ./col -->
    </div>
    <!-- /.row -->
    <!-- Main row -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Logs</h3>
                    <div class="card-tools">
                        <!-- <div class="input-group input-group-sm" style="width: 150px;">
                            <input type="text" name="table_search" class="form-control float-right" placeholder="Search" disabled>
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-default" disabled>
                                <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div> -->
                    </div>
                </div>
                <!-- /.card-header -->
                <div class="card-body table-responsive p-0" style="height: 300px;" id="ListAccesses">
                <table class="table table-head-fixed text-nowrap">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Date</th>
                        <th>Area</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                </div>
                <!-- /.card-body -->
            </div>
        </div>  
    </div>
    <div class="row mb-2">
        <div class="col-12">
            <h4>Add/Edit/View Users</h4>
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-sm-6" style="text-align: right;">
            <label>Search by Building and/or Name Surname </label>
        </div>
        <div class="col-sm-4 mb-4">
            <select id="select_building" class="form-control select2" style="width: 100%;">
              <option selected="selected" number="0"></option>
            </select>
        </div>
        <div class="col-sm-2">
            <div class="input-group input-group">
                <input type="text" id="search_workes" class="form-control float-right" placeholder="Search">
                <div class="input-group-append">
                    <button type="submit" class="btn btn-default" disabled>
                    <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
        <div class="card card-solid">
            <div class="card-body pb-0">
            <div class="row" id="show_workers">
                
            </div>
            </div>
            <!-- /.card-body -->
            <div class="card-footer">
            <nav aria-label="Contacts Page Navigation">
                <ul class="pagination justify-content-center m-0" id="workes_page_navigation">
                </ul>
            </nav>
            </div>
            <!-- /.card-footer -->
        </div>
        </div>
    </div>
    <!-- /.row (main row) -->
    </div><!-- /.container-fluid -->
</section>
<!-- /.content -->

<div class="modal fade" id="modal-xl">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Confirm Remove User from Business</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body" id="show_remove_info">
				<p id="user_remove_notification">User <b id="user_remove_name"></b> will be removed from the business.</p>
			</div>
			<div class="modal-footer justify-content-between">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				<button type="button" class="btn btn-danger" id="save_remove_action">Remove User</button>
			</div>
	    </div>
	    <!-- /.modal-content -->
    </div>
	<!-- /.modal-dialog -->
</div>

<div class="modal fade" id="modal-add-user">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Add new user to the Business</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body" id="show_remove_info">
                <div class="row">
				    <p>
                        You can add an user by either writing the username or the CF.
                    </p>
                </div>
                <div class="row">
                    <p>
                        The user will receive a notification and can accept o refuse the invite.
                    </p>
                </div>
                <div class="row">
                    <p>
                        You can also specify the role of the new user in the current business (USR - CO - CA).
                    </p>
                </div>
                <div class="row">
                    <p>
                        You will not be informed about the existence of the user. Please read carefully the data before submit.
                    </p>
                </div>
                <div class="row">
                    <div class="form-group col-4">
                      <label for="adduser_username">Username</label>
                      <input type="text" id="adduser_username" class="form-control">
                    </div>
                    <div class="form-group col-8">
                      <label for="adduser_CF">CF</label>
                      <div class="input-group mb-3">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i class="fas fa-phone"></i></span>
                        </div>
                        <input type="text" class="form-control" id="adduser_CF">
                      </div>
                    </div>
                </div>
			</div>
			<div class="modal-footer justify-content-between">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				<button type="button" class="btn btn-success" id="add_user">Add User</button>
			</div>
	    </div>
	    <!-- /.modal-content -->
    </div>
	<!-- /.modal-dialog -->
</div>

<script>
        var userReceived = [];
        function showWorkers(obj) {
            $.each( obj.data, function( key, value ) {
                data = obj.data[key];
                data_len = obj.data.length;
                data_grid = "col-12 col-sm-6 col-md-4";
                if (data_len == 1) {
                    data_grid = "col-12 col-sm-12 col-md-12";
                }
                if (data_len == 2) {
                    data_grid = "col-12 col-sm-6 col-md-6";
                }

                userReceived[data["id"]] = data;

                $("#show_workers").append
                (
                '<div class="'+data_grid+' d-flex align-items-stretch flex-column"> \
                    <div class="card bg-light d-flex flex-fill"> \
                    <div class="card-header text-muted border-bottom-0"> \
                        '+data["name"]+' '+data["surname"]+' \
                    </div> \
                    <div class="card-body pt-0"> \
                        <div class="row"> \
                        <div class="col-7"> \
                            <h2 class="lead"><b>'+data["username"]+'</b></h2> \
                            <p class="text-muted text-sm"><b>Role: </b>'+expandRole(data["role"])+'</p> \
                            <ul class="ml-4 mb-0 fa-ul text-muted"> \
                            <li class="small"><span class="fa-li"><i class="fas fa-lg fa-building"></i></span> Address: Function not implemented</li> \
                            <li class="small"><span class="fa-li"><i class="fas fa-lg fa-phone"></i></span> Phone #: Function not implemented</li> \
                            </ul> \
                        </div> \
                        <div class="col-5 text-center"> \
                            <img src="../../dist/img/user1-128x128.jpg" alt="user-avatar" class="img-circle img-fluid"> \
                        </div> \
                        </div> \
                    </div> \
                    <div class="card-footer"> \
                        <div class="text-right"> \
					    <button type="button" class="btn btn-sm btn-danger" id="remove_user" number='+data["id"]+' data-toggle="modal" data-target="#modal-xl"> \
                            <i class="fas fa-user-slash"></i> Remove Profile \
					    </button> \
                        <a href="editprofile.html?id='+data["id"]+'" class="btn btn-sm btn-warning"> \
                            <i class="fas fa-user-edit"></i> Edit Profile \
                        </a> \
                        <a href="viewprofile.html?id='+data["id"]+'" class="btn btn-sm btn-primary"> \
                            <i class="fas fa-user"></i> View Profile \
                        </a> \
                        </div> \
                    </div> \
                    </div> \
                </div>'
                );
            });
        }
        
        function sendRequest_getWorkes(page_number, filter, filter_building) {
            // Request a new page in the show workes section
            
            var pageNumber = page_number;
        
            $.post("get_info.php", 
            { 
                info_id: 1,
                page: pageNumber,
                filter: filter,
                filter_building: filter_building
            },
            
            function(data, status, xhr) {
                $("#show_workers").empty();
                $("#workes_page_navigation").empty();
                obj = JSON.parse(data);
                if (xhr.status == 200) {
                    var iteration = obj.amount/9;
                    if (iteration == 0)
                        iteration = 1;
                        
                    var found = 0;
                    for(let i = 1; i < 1 + iteration; i++) {
                        if (i == pageNumber) {
                            found = 1;
                            $("#workes_page_navigation").append
                            ('<li class="page-item active" id="page_number" number="'+i+'"><a class="page-link">'+i+'</a></li>');
                        } else
                            $("#workes_page_navigation").append
                            ('<li class="page-item" id="page_number" number="'+i+'"><a class="page-link">'+i+'</a></li>');
                        if(found == 0) {
                            $("#workes_page_navigation [number="+Math.ceil(iteration)+"]").addClass("active");
                        }
                    }
                    
                    if (obj.data) {
                        showWorkers(obj);
                    } else {
                        //alert("No workes found..");
                    }
                } else responseByID(obj.response);
            });
        }

    $(document).ready(function(){

        $.post("get_info.php", 
        { 
            info_id: "5",
            role: "CA",
            filter: ""
        },
        
        function(data, status, xhr) {
            if (xhr.status == 200) {
            
            } else {
                alert("You do not have the permission to see this page.");
            }
        });

        sendRequest_getWorkes(1, "", 0);
        
        $(document).on('click', "#page_number", function(){
            var building_id = $("#select_building option:selected" ).attr("number");
            var pageNumber = $(this).attr('number');
            sendRequest_getWorkes(pageNumber, $('#search_workes').val(), building_id);
        });

        $('#search_workes').on('input', function() {
            var building_id = $("#select_building option:selected" ).attr("number");
            
            $("#show_workers .card > .overlay").remove();
            $("#show_workers .card").append(
            '<div class="overlay" id="lol"> \
                <i class="fas fa-3x fa-sync-alt"></i> \
            </div>'
            );
            sendRequest_getWorkes(1, $('#search_workes').val(), building_id);
        });
    
        $('#select_building').change(function(){ 
            var building_id = $("#select_building option:selected" ).attr("number");
            sendRequest_getWorkes(1, $('#search_workes').val(), building_id);
        });

        $.post("get_info.php", 
        { 
            info_id: "0",
        },
        
        function(data, status, xhr) {
            if (xhr.status == 200) {
                obj = JSON.parse(data);
                
                if (obj.data) {
                    $.each( obj.data, function( key, value ) {
                    data = obj.data[key];
                    $("#ListAccesses tbody").append("<tr>"+
                        "<td>"+data["id"]+"</td>"+
                        "<td>"+data["PersonID"]+"</td>"+
                        "<td>"+data["Time"]+"</td>"+
                        "<td>"+data["Area"]+"</td>"+
                        "<td>"+data["action"]+"</td>"+
                        "</tr>");
                    });
                }
            } else responseByID(obj.response);     
        });

        $.post("get_info.php", 
        { 
            info_id: "4",
        },
        
        function(data, status, xhr) {
            obj = JSON.parse(data);
            if (xhr.status == 200) {
                if (obj.business_name) {
                    $("#business_name").text("["+obj.business_name+"] Dashboard - Customer Administrator")
                }
            } else responseByID(obj.response);
        });


        var userToBeRemoved;
        
        $(document).on('click', "#remove_user", function(){
            var userid = $(this).attr('number');
            userToBeRemoved = userid;
            $("#user_remove_name").text(userReceived[userid]["name"]+" "+userReceived[userid]["surname"]);
        });
        
        $(document).on('click', "#save_remove_action", function(){
            $("#save_remove_action").attr("disabled", '');    
            //$('#modal-xl').modal('hide')
            $.post("set_info.php", 
            { 
                set_function: 3,
                id: userToBeRemoved
            },
            
            function(data, status, xhr) {
                if (xhr.status == 200) {
                    $('#modal-xl').modal('hide');
                    location.reload();
                } else {
                    obj = JSON.parse(data);
                    responseByID(obj.response);
                }
            });
        });

    var businessInformation = {
      building : new Array
    };

    $.post("get_info.php", 
    { 
      info_id: "8",
    },
    
    function(data, status, xhr) {
      if (xhr.status == 200) {
        obj = JSON.parse(data);
        if (obj.data) {
          if (obj.data.building) {
              $.each( obj.data.building, function( key, value ) {
                data = obj.data.building[key];
                businessInformation["building"][key] = {building_name: data["building_name"]};
                $("#select_building").append('<option number="'+key+'">'+data["building_name"]+'</option>');
              });
          }
        }
      } else responseByID(obj.response);
    });

        
    });
</script>
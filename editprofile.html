<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AdminLTE 3 | Edit Profile</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../dist/css/adminlte.min.css">
    <!-- daterangVe picker -->
  <link rel="stylesheet" href="../../plugins/daterangepicker/daterangepicker.css">
</head>
<style>
  #building_access_list ul {
    margin-top: 0.3rem;
  }
</style>
<body class="hold-transition sidebar-mini layout-fixed">
<!-- Site wrapper -->
<div class="wrapper">

  <!-- Preloader -->
  <div class="preloader flex-column justify-content-center align-items-center">
    <img class="animation__shake" src="dist/img/AdminLTELogo.png" alt="AdminLTELogo" height="60" width="60">
  </div>
  
  <!-- Navbar -->
  <div id="navbar_container"></div>
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  <div id="sidebar_container"></div>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Edit Profile</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item active">Edit Profile</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="row">
        <div class="col-md-6">
          <div class="card card-primary">
            <div class="card-header">
              <h3 class="card-title">User Information</h3>
              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                  <i class="fas fa-minus"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="form-group">
                <div class="row">
                  <div class="col-6">
                    <label for="inputName">Name</label>
                    <input type="text" disabled id="profile_name" class="form-control">
                  </div>
                  <div class="col-6">
                    <label for="inputName">Surname</label>
                    <input type="text" disabled id="profile_surname" class="form-control">
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="inputStatus">Role</label>
                <select id="inputStatus" class="form-control custom-select">
                  <option disabled="">SA</option>
                  <option id="CA_option" number="CA">CA</option>
                  <option id="CO_option" number="CO">CO</option>
                  <option id="USR_option" number="USR">USR</option>
                </select>
              </div>
              <div class="form-group">
                <label for="user_main_building">Main Building</label>
                <select id="user_main_building" class="form-control">
                
                </select>
              </div>
            </div>
            <!-- /.card-body -->
          </div>
          <!-- /.card -->
        </div>
        <div class="col-md-6">
          <div class="card card-secondary">
            <div class="card-header">
              <h3 class="card-title">User Business Related Information</h3>

              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                  <i class="fas fa-minus"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label>Birthday</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                  </div>
                  <input type="text" class="form-control" data-inputmask-alias="datetime" data-inputmask-inputformat="dd/mm/yyyy" data-mask="" inputmode="numeric" id="profile_birthday">
                </div>
              </div>
              <div class="row">
                <div class="col-8">
                  <div class="form-group">
                    <label for="inputName">Street</label>
                    <input type="text" id="profile_street" class="form-control">
                  </div>
                </div>
                <div class="col-4">
                  <div class="form-group">
                    <label for="inputName">Number</label>
                    <input type="text" id="profile_street_number" class="form-control">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="form-group col-4">
                  <label for="inputName">City</label>
                  <input type="text" id="profile_city" class="form-control">
                </div>
                <div class="form-group col-4">
                  <label for="inputName">Country</label>
                  <input type="text" id="profile_country" class="form-control">
                </div>
                <div class="col-4">
                  <div class="form-group">
                    <label for="inputName">Zip</label>
                    <input type="text" id="profile_zip" class="form-control">
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="inputName">Business Email</label>
                <div class="input-group mb-3">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                  </div>
                  <input type="email" class="form-control" id="profile_business_email">
                </div>
              </div>
              <div class="row">
                <div class="form-group col-4">
                  <label for="inputName">Prefix</label>
                  <input type="text" id="profile_cellphone_prefix" class="form-control">
                </div>
                <div class="form-group col-8">
                  <label for="inputName">Business Cellphone</label>
                  <div class="input-group mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-phone"></i></span>
                    </div>
                    <input type="text" class="form-control" id="profile_business_cellphone">
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="profile_sex">Sex</label>
                <select id="profile_sex" class="form-control custom-select">
                  <option id="male_option" number="Male">Male</option>
                  <option id="female_option" number="Female">Female</option>
                  <option id="others_option" number="Others">Others</option>
                </select>
              </div>
            </div>
            <!-- /.card-body -->
          </div>
          <!-- /.card -->
        </div>
        <div class="col-6">
          <div class="card card-primary">
            <div class="card-header">
              <h3 class="card-title">User Area Access Permission</h3>
              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                  <i class="fas fa-minus"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <p class="login-box-msg">View/Modify User Area Permission</p>
              <ul class="list-group" id="building_access_list">
              </ul>
              <div class="social-auth-links text-center mb-3">
                <p>- OR -</p>
              </div>
              <p class="login-box-msg">Add User Area Permission</p>
              <div class="form-group">
                <label for="add_area_permission_select_main_building">Main Building</label>
                <select id="add_area_permission_select_main_building" class="form-control">
                
                </select>
              </div>
              <div class="form-group">
                <label for="add_area_permission_select_area">Select an Area</label>
                <select id="add_area_permission_select_main_building" class="form-control">
                
                </select>
              </div>
              <div class="form-group">
					      <button type="button" class="btn btn-success float-right" id="add_area_permission" data-toggle="modal" data-target="#modal-add-area-permission">
                  Add Area Permission
					      </button>
              </div>
            </div>
            <!-- /.card-body -->
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
					<button type="button" class="btn btn-success float-right" id="save_changes" data-toggle="modal" data-target="#modal-xl">
						Save Changes
					</button>
        </div>
      </div>
    </section>
    <!-- /.content -->
  </div>
	
	<div class="modal fade" id="modal-xl">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Confirm Edit</h4>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="show_changes">
				
        </div>
				<div class="modal-footer justify-content-between">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" id="save_changes_confirm">Save changes</button>
				</div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal-dialog -->
	</div>
	
  <div class="modal fade" id="modal-add-area-permission">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Add Area Permission to the User</h4>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="show_info_area">
				
        </div>
				<div class="modal-footer justify-content-between">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" id="save_changes_confirm">Save changes</button>
				</div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal-dialog -->
	</div>
  
  <div class="modal fade" id="modal-remove-area-permission">
		<div class="modal-dialog modal-xl">
			<div class="modal-content bg-danger">
				<div class="modal-header">
					<h4 class="modal-title">Confirm Remove Area Permission</h4>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="show_info_remove_area">
				
        </div>
				<div class="modal-footer justify-content-between">
					<button type="button" class="btn btn-outline-light" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-outline-light" id="remove_area_permission_confirm">Save changes</button>
				</div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal-dialog -->
	</div>
  <!-- /.content-wrapper -->

  <div id="footer_container">
  </div>
</div>
<!-- ./wrapper -->

<!-- jQuery -->
<script src="../../plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- InputMask -->
<script src="../../plugins/moment/moment.min.js"></script>
<script src="../../plugins/inputmask/jquery.inputmask.min.js"></script>
<!-- Error function Handling -->
<script src="dist/js/error.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.js"></script>

<script>
  $(document).ready(function(){
    $("#sidebar_container").load("sidebar_CA.html");
    $("#navbar_container").load("navbar_CA.html");
    $("#footer_container").load("footer.html");

    //Datemask dd/mm/yyyy
    $('#profile_birthday').inputmask('dd/mm/yyyy', { 'placeholder': 'dd/mm/yyyy' })

    $.urlParam = function(name){
      var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
      if (results==null){
        return null;
      }
      else{
        return results[1] || 0;
      }
    }

    // -- Those functions are used for edit the user area permissions
    var id_to_modify;
    if($.urlParam('id') != null) {
      id_to_modify = $.urlParam('id');
    } else {
      alert("ERRORE");
      window.location.href = 'index.html';
    }
   
    var areaInformation;
    $.post("get_info.php", 
    { 
      info_id: "14",
      id: id_to_modify
    },
    
    function(data, status, xhr) {
      if (xhr.status == 200) {
        obj = JSON.parse(data);
        areaInformation = JSON.parse(data);
        if (obj.data) {
          $.each( obj.data, function( key, value ) {
            areas_array = obj.data[key].areas;
            building_name = obj.data[key].building_name;
            $("#building_access_list").append("<li class='list-group-item' number="+key+" type='building'>"+building_name+"</li>");
            $("li[number="+key+"][type='building']").append("<ul class='list-group list-group-flush' type='areas' id_building="+key+" number=0></ul>");
            var condition = true;
            while(condition) {
              condition = false;
              $.each( areas_array, function( key1, value1 ) {
                condition = true;
                areas_id = key1;
                access_granted = value1.access_granted;
                area_name = value1.area_name;
                whitelist = value1.whitelist;
                parent_id = value1.parent_id;
                if (parent_id == 0) {
                  $("ul[id_building="+key+"][type='areas'][number='0']").append('<li class="list-group-item" area_id='+areas_id+' type="area"> \
                    <div class="row"> \
                      <div class="col-8"> \
                      <div style="margin-right: 2.5em;">'+area_name+'</div> \
                      </div> \
                      <div class="col-4"> \
                      <button data-toggle="modal" data-target="#modal-remove-area-permission" purpose="remove_permission" area="'+areas_id+'" type="button" class="btn btn-block btn-danger btn-xs float-right" style="width:60px;">Remove</button> \
                      </div> \
                    </div></li>');
                    delete(obj.data[key].areas[key1]);
                } else {
                  if ($("li[type='area'][area_id='"+parent_id+"']").length) {
                    $("li[type='area'][area_id='"+parent_id+"']").append('\
                    <ul class="list-group"> \
                      <li class="list-group-item" area_id='+areas_id+' type="area"> \
                        <div class="row"> \
                        <div class="col-8"> \
                          <div style="margin-right: 2.5em;">'+area_name+'</div> \
                        </div> \
                        <div class="col-4"> \
                          <button data-toggle="modal" data-target="#modal-remove-area-permission" purpose="remove_permission" area="'+areas_id+'" type="button" class="btn btn-block btn-danger btn-xs float-right" style="width:60px;">Remove</button> \
           			        </div> \
                        </div> \
                      </li> \
                    </ul>');
                    delete(obj.data[key].areas[key1]);
                  } 
                }
              });
            }
              
          });
        }
      } else responseByID(obj.response);
    });

    function findParentAreas(area_id, building_id) {
      var parent_areas = new Array();
      var id_to_check = area_id;
      while (true) {
        var parent_id = areaInformation.data[building_id].areas[id_to_check].parent_id;
        if (parent_id == 0) {
          // parent_areas.push(id_to_check); 
          break;
        }
        
        id_to_check = parent_id;
        parent_areas.push(parent_id); 
      }
      
      return parent_areas;
    }
    
    function findChildAreas(area_id, building_id) {
      var child_areas = new Array();
      var id_to_check = area_id;
      while (true) {
        var found = 0;
        Object.keys(areaInformation["data"][building_id]["areas"]).forEach(index => {
          var parent_id = areaInformation["data"][building_id]["areas"][index].parent_id;
          if (parent_id == id_to_check) {
            child_areas.push(index);
            found = 1;
            id_to_check = index;
          }
        });
        if (!found)
          break;
      }
      
      return child_areas;
    }
    
    $(document).on('click', "[purpose='remove_permission']", function(){
      var area_id = $(this).parent().closest('li').attr("area_id");
      var building_id = $(this).parent().closest('ul[type="areas"]').attr("id_building");
      var area_name = areaInformation.data[building_id].areas[area_id].area_name;
      var building_name = areaInformation.data[building_id].building_name;
      var parent_array = findChildAreas(area_id, building_id);
      $("#show_info_remove_area").empty();
      $("#show_info_remove_area").append('\
        <div class="row"> \
          <p>You are trying to remove the permission for the Area <b>'+area_name+'</b> ('+area_id+') in the Building <b>'+building_name+'</b> ('+building_id+')!</p> \
        </div>');
      
      if (parent_array.length != 0) {
        $("#show_info_remove_area").append('\
          <div class="row"> \
            <p>This will remove also the access in the following areas: </p>\
          </div><ul id="show_area_involved"></ul>');
        $("#show_area_involved").empty();
        parent_array.forEach(element => {
          var area_name2 = areaInformation.data[building_id].areas[element].area_name;
          $("#show_area_involved").append('<li>'+area_name2+'</li>');
        });
      }
      
    });

    // -- END
    
    // -- This function is used to retrieve the information related to the business buildings
    var businessInformation = {
      building : new Array
    };

    $.post("get_info.php", 
    { 
      info_id: "8",
    },
    
    function(data, status, xhr) {
      if (xhr.status == 200) {
        obj = JSON.parse(data);
        if (obj.data) {
          if (obj.data.building) {
              $.each( obj.data.building, function( key, value ) {
                data = obj.data.building[key];
                businessInformation["building"][key] = {building_name: data["building_name"], areas: new Array()};
                $("#user_main_building").append('<option number="'+key+'">'+data["building_name"]+'</option>');
              });
          }
        }
      } else responseByID(obj.response);
    });
    // -- END FUNCTION

    var userInformation = new Array();
    const expected_param = [
      "name",
      "surname",
		  "birthdate",
		  "id_business_building",
		  "business_email",
		  "city",
		  "country",
		  "role",
		  "sex",
		  "street",
      "number",
		  "telephone",
		  "telephone_prefix",
		  "zip"
    ];
    const text_field = {
      "profile_name" : "name",
      "profile_surname" : "surname",
		  "profile_birthday" : "birthdate",
		  "profile_business_email" : "business_email",
		  "profile_city" : "city",
		  "profile_country" : "country",
		  "profile_street" : "street",
		  "profile_street_number" : "number",
		  "profile_business_cellphone" : "telephone",
		  "profile_cellphone_prefix" : "telephone_prefix",
		  "profile_zip" : "zip"
    };

    var select_input = {
      "sex" : "#profile_sex option:selected", 
      "role" : "#inputStatus option:selected",
      "id_business_building" : "#user_main_building option:selected"
    }

    const role_to_element_id = {
      "USR" : "#USR_option",
      "CO"  : "#CO_option",
      "CA"  : "#CA_option",
    }
    
    const sex_to_element_id = {
      "Male"    : "#male_option",
      "Female"  : "#female_option",
      "Others"  : "#others_option",
    }

    var id_to_modify;
    if($.urlParam('id') != null) {
      id_to_modify = $.urlParam('id');
    } else {
      id_to_modify = 0;
    }

    $.post("get_info.php", 
    { 
      info_id: "3",
      id: id_to_modify
    },
    
    function(data, status, xhr) {
      obj = JSON.parse(data);
      if (xhr.status == 200) {
        if (obj.data) {
          expected_param.forEach((value) => {
            if(obj.data[value] == null) {
              alert("An error occurred. Field "+value+" is missing.");
            } else {
              userInformation[value] = obj.data[value];
              Object.keys(text_field).forEach(key => {
                $("#"+key).val(obj.data[text_field[key]]);
              });
            }
          });
          
          $("#user_main_building [number = '"+obj.data["id_business_building"]+"']").attr('selected', '');

          $(role_to_element_id[obj.data["role"]]).attr('selected', '');
          
          $(sex_to_element_id[obj.data["sex"]]).attr('selected', '');
        }
      } else {
        alert("AAAA"); 
        responseByID(obj.response); 
        alert("PD");
      }
    });
    
    var data = {
      "name" : "",
      "surname" : "",
		  "birthdate" : "",
		  "id_business_building" : "",
		  "business_email" : "",
		  "city" : "",
		  "country" : "",
		  "role" : "",
		  "sex" : "",
		  "street" : "",
      "number" : "",
		  "telephone" : "",
		  "telephone_prefix" : "",
		  "zip" : ""
    };
    $("#save_changes").click(function(){
      $("#show_changes").empty();
      Object.keys(text_field).forEach(key => {
        if (userInformation[text_field[key]] != $("#"+key).val()) {
          $("#show_changes").append('\
            <div class="row"> \
              <p>'+text_field[key]+' will be modified from <b>'+userInformation[text_field[key]]+'</b> to <b>'+$("#"+key).val()+'</b></p> \
            </div>');
          data[text_field[key]] = $("#"+key).val();
        }
      });
      
      Object.keys(select_input).forEach(key => {
        if (userInformation[key] != $(select_input[key]).attr("number")) {
          $("#show_changes").append('\
            <div class="row"> \
              <p>'+key+' will be modified from <b>'+userInformation[key]+'</b> to <b>'+$(select_input[key]).attr("number")+'</b></p> \
            </div>');
          data[key] = $(select_input[key]).attr("number");
        }
      });
    });

		$("#save_changes_confirm").click(function(){
			$.post("set_info.php", 
      { 
      	set_function: "0",
				id: $.urlParam('id'),
      	data: JSON.stringify(data) 
      },
      
      function(data, status) {
        obj = JSON.parse(data);
        if (obj.code == 41) {
          alert("Something went wrong");
        } else if (obj.code == 42) {
          location.reload();
        } else {
          alert("Something went wrong (others)");
        }
      });
		});
  });
</script>
</body>
</html>

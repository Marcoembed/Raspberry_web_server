<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AdminLTE 3 | Edit Profile</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../dist/css/adminlte.min.css">
    <!-- daterange picker -->
  <link rel="stylesheet" href="../../plugins/daterangepicker/daterangepicker.css">
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<!-- Site wrapper -->
<div class="wrapper">

  <!-- Preloader -->
  <div class="preloader flex-column justify-content-center align-items-center">
    <img class="animation__shake" src="dist/img/AdminLTELogo.png" alt="AdminLTELogo" height="60" width="60">
  </div>
  
  <!-- Navbar -->
  <div id="navbar_container"></div>
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  <div id="sidebar_container"></div>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Edit Profile</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item active">Edit Profile</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="row">
        <div class="col-md-6">
          <div class="card card-primary">
            <div class="card-header">
              <h3 class="card-title">User Information</h3>

              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                  <i class="fas fa-minus"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label for="inputName">Name</label>
                <input type="text" id="profile_name" class="form-control">
              </div>
              <div class="form-group">
                <label for="inputName">Surname</label>
                <input type="text" id="profile_surname" class="form-control">
              </div>
              <div class="form-group">
                <label for="inputName">Username</label>
                <input type="text" id="profile_username" class="form-control">
              </div>
              <div class="form-group">
                <label for="inputName">Email</label>
                <input type="text" id="profile_email" class="form-control">
              </div>
            </div>
            <!-- /.card-body -->
          </div>
          <!-- /.card -->
        </div>
        <div class="col-md-6">
          <div class="card card-secondary">
            <div class="card-header">
              <h3 class="card-title">User Business Related Information</h3>

              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                  <i class="fas fa-minus"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label>Birthday</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                  </div>
                  <input type="text" class="form-control" data-inputmask-alias="datetime" data-inputmask-inputformat="dd/mm/yyyy" data-mask="" inputmode="numeric" id="profile_birthday">
                </div>
              </div>
              <div class="row">
                <div class="col-8">
                  <div class="form-group">
                    <label for="inputName">Street</label>
                    <input type="text" id="profile_street" class="form-control">
                  </div>
                </div>
                <div class="col-4">
                  <div class="form-group">
                    <label for="inputName">Number</label>
                    <input type="text" id="profile_street_number" class="form-control">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="form-group col-4">
                  <label for="inputName">City</label>
                  <input type="text" id="profile_city" class="form-control">
                </div>
                <div class="form-group col-4">
                  <label for="inputName">Country</label>
                  <input type="text" id="profile_country" class="form-control">
                </div>
                <div class="col-4">
                  <div class="form-group">
                    <label for="inputName">Zip</label>
                    <input type="text" id="profile_zip" class="form-control">
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="inputName">Business Email</label>
                <div class="input-group mb-3">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                  </div>
                  <input type="email" class="form-control" id="profile_business_email">
                </div>
              </div>
              <div class="row">
                <div class="form-group col-4">
                  <label for="inputName">Prefix</label>
                  <input type="text" id="profile_cellphone_prefix" class="form-control">
                </div>
                <div class="form-group col-8">
                  <label for="inputName">Business Cellphone</label>
                  <div class="input-group mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-phone"></i></span>
                    </div>
                    <input type="text" class="form-control" id="profile_business_cellphone">
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="profile_sex">Sex</label>
                <select id="profile_sex" class="form-control custom-select">
                  <option id="male_option" number="Male">Male</option>
                  <option id="female_option" number="Female">Female</option>
                  <option id="others_option" number="Others">Others</option>
                </select>
              </div>
            </div>
            <!-- /.card-body -->
          </div>
          <!-- /.card -->
        </div>
      </div>
      <div class="row">
        <div class="col-12">
					<button type="button" class="btn btn-success float-right" id="save_changes" data-toggle="modal" data-target="#modal-xl">
						Save Changes
					</button>
        </div>
      </div>
    </section>
    <!-- /.content -->
  </div>
	
	<div class="modal fade" id="modal-xl">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Confirm Edit</h4>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="show_changes">
					<p id="noEdit" style="display: none;">No Edit Found</p>
					<p id="name_change_notification">Name will be modified from <b id="oldName"></b> to <b id="newName"></b></p>
					<p id="surname_change_notification">Surname will be modified from <b id="oldSurname"></b> to <b id="newSurname"></b></p>
					<p id="username_change_notification">Username will be modified from <b id="oldUsername"></b> to <b id="newUsername"></b></p>
					<p id="email_change_notification" style="display: none;">Email will be modified from <b id="oldEmail"></b> to <b id="newEmail"></b></p>
				</div>
				<div class="modal-footer justify-content-between">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" id="save_changes_confirm">Save changes</button>
				</div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal-dialog -->
	</div>
  <!-- /.content-wrapper -->

  <div id="footer_container">
  </div>
</div>
<!-- ./wrapper -->

<!-- jQuery -->
<script src="../../plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- InputMask -->
<script src="../../plugins/moment/moment.min.js"></script>
<script src="../../plugins/inputmask/jquery.inputmask.min.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.js"></script>

<script>
  $(document).ready(function(){
    $("#sidebar_container").load("sidebar_CA.html");
    $("#navbar_container").load("navbar_CA.html");
    $("#footer_container").load("footer.html");
    
    const NumberOfRequestBeforeReady = 1;
    var NumberOfRequest = 0; 
    
    var intervalId = setInterval(function() {
        if (NumberOfRequest == NumberOfRequestBeforeReady) {
            // console.log(NumberOfRequest);
            $(".preloader").css('height', 0);
            $(".preloader").children().hide();
        }
    }, 200);

    //Datemask dd/mm/yyyy
    $('#profile_birthday').inputmask('dd/mm/yyyy', { 'placeholder': 'dd/mm/yyyy' })

    var userInformation = new Array();
    const expected_param = [
      "name",
      "surname",
      "username",
      "email",
		  "birthdate",
		  "business_email",
		  "city",
		  "country",
		  "sex",
		  "street",
      "number",
		  "telephone",
		  "telephone_prefix",
		  "zip"
    ];
    const text_field = {
      "profile_name"      : "name",
      "profile_surname"   : "surname",
      "profile_username"  : "username",
      "profile_email"     : "email",
		  "profile_birthday"  : "birthdate",
		  "profile_business_email" : "business_email",
		  "profile_city"      : "city",
		  "profile_country"   : "country",
		  "profile_street"    : "street",
		  "profile_street_number" : "number",
		  "profile_business_cellphone" : "telephone",
		  "profile_cellphone_prefix" : "telephone_prefix",
		  "profile_zip"       : "zip"
    };
    const select_input = {
      "sex" : "#profile_sex option:selected" 
    }
    const sex_to_element_id = {
      "Male"    : "#male_option",
      "Female"  : "#female_option",
      "Others"  : "#others_option",
    }
    
    // This variable is used to being able to use a for loop to gather all the information to be sended to the server.
    var data = {
      "name" : "",
      "surname" : "",
      "username" : "",
      "email" : "",

		  "birthdate" : "",
		  "street" : "",
      "number" : "",
		  "city" : "",
		  "country" : "",
		  "zip" : "",
		  "business_email" : "",
		  "telephone" : "",
		  "telephone_prefix" : "",
		  "sex" : ""
    };

    $.post("get_info.php", 
    { 
      info_id: "3",
      id: 0
    },
    
    function(data, status, xhr) {
      obj = JSON.parse(data);
      if (xhr.status == 200) {
        if (obj.data) {
          expected_param.forEach((value) => {
            if(obj.data[value] == null) {
              alert("An error occurred. Field "+value+" is missing.");
            } else {
              userInformation[value] = obj.data[value];
              Object.keys(text_field).forEach(key => {
                $("#"+key).val(obj.data[text_field[key]]);
              });
            }
          });
          
          $(sex_to_element_id[obj.data["sex"]]).attr('selected', '');
          NumberOfRequest++;
        }
      } else {
        alert("AAAA"); 
        responseByID(obj.response); 
      }
    });
      
    $("#save_changes").click(function(){
      $("#show_changes").empty();
      var editFound = 0;
      Object.keys(text_field).forEach(key => {
        if (userInformation[text_field[key]] != $("#"+key).val()) {
          $("#show_changes").append('\
            <div class="row"> \
              <p>'+text_field[key]+' will be modified from <b>'+userInformation[text_field[key]]+'</b> to <b>'+$("#"+key).val()+'</b></p> \
            </div>');
          data[text_field[key]] = $("#"+key).val();
          editFound = 1;
        } else {
            data[key] = "";
        }
      });
      
      Object.keys(select_input).forEach(key => {
        if (userInformation[key] != $(select_input[key]).attr("number")) {
          $("#show_changes").append('\
            <div class="row"> \
              <p>'+key+' will be modified from <b>'+userInformation[key]+'</b> to <b>'+$(select_input[key]).attr("number")+'</b></p> \
            </div>');
            data[key] = $(select_input[key]).attr("number");
            editFound = 1;
        } else {
            data[key] = "";
        }
      });

      // If no edit is found, we disable the save changes confirm button to avoid user spamming useless post request
      if (!editFound)
        $("#save_changes_confirm").attr("disabled", "");
      else
        $("#save_changes_confirm").removeAttr("disabled");
    
    });

    var KnownErrors = {
      "Cant_Edit_CA/SA" : "You cannot edit the role of a CA/SA"
    };

		$("#save_changes_confirm").click(function(){
			$.post("set_info.php", 
      { 
      	set_function: "0",
				id: 0,
      	data: JSON.stringify(data) 
      },
      
      function(data, status) {
        obj = JSON.parse(data);
        if (KnownErrors[obj.code] != null) {
          alert(KnownErrors[obj.code]);
        } else if (obj.code == 42) {
          location.reload();
        } else {
          alert("Something went wrong (others)");
        }
      });
		});
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AdminLTE 3 | Edit Profile</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../dist/css/adminlte.min.css">
    <!-- daterange picker -->
  <link rel="stylesheet" href="../../plugins/daterangepicker/daterangepicker.css">
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<!-- Site wrapper -->
<div class="wrapper">

  <!-- Preloader -->
  <div class="preloader flex-column justify-content-center align-items-center">
    <img class="animation__shake" src="dist/img/AdminLTELogo.png" alt="AdminLTELogo" height="60" width="60">
  </div>
  
  <!-- Navbar -->
  <div id="navbar_container"></div>
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  <div id="sidebar_container"></div>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Edit Profile</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item active">Edit Profile</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="row">
        <div class="col-md-6">
          <div class="card card-primary">
            <div class="card-header">
              <h3 class="card-title">User Information</h3>

              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                  <i class="fas fa-minus"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label for="inputName">Name</label>
                <input type="text" id="profile_name" class="form-control">
              </div>
              <div class="form-group">
                <label for="inputName">Surname</label>
                <input type="text" id="profile_surname" class="form-control">
              </div>
              <div class="form-group">
                <label for="inputName">Username</label>
                <input type="text" id="profile_username" class="form-control">
              </div>
              <div class="form-group">
                <label for="inputName">Email</label>
                <input type="text" id="profile_email" class="form-control">
              </div>
            </div>
            <!-- /.card-body -->
          </div>
          <!-- /.card -->
        </div>
        <div class="col-md-6">
          <div class="card card-secondary">
            <div class="card-header">
              <h3 class="card-title">User Business Related Information</h3>

              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                  <i class="fas fa-minus"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label>Birthday</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                  </div>
                  <input type="text" class="form-control" data-inputmask-alias="datetime" data-inputmask-inputformat="dd/mm/yyyy" data-mask="" inputmode="numeric" id="profile_birthday">
                </div>
              </div>
              <div class="row">
                <div class="col-8">
                  <div class="form-group">
                    <label for="inputName">Street</label>
                    <input type="text" id="profile_street" class="form-control">
                  </div>
                </div>
                <div class="col-4">
                  <div class="form-group">
                    <label for="inputName">Number</label>
                    <input type="text" id="profile_street_number" class="form-control">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="form-group col-4">
                  <label for="inputName">City</label>
                  <input type="text" id="profile_city" class="form-control">
                </div>
                <div class="form-group col-4">
                  <label for="inputName">Country</label>
                  <input type="text" id="profile_country" class="form-control">
                </div>
                <div class="col-4">
                  <div class="form-group">
                    <label for="inputName">Zip</label>
                    <input type="text" id="profile_zip" class="form-control">
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="inputName">Business Email</label>
                <div class="input-group mb-3">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                  </div>
                  <input type="email" class="form-control" id="profile_business_email">
                </div>
              </div>
              <div class="row">
                <div class="form-group col-4">
                  <label for="inputName">Prefix</label>
                  <input type="text" id="profile_cellphone_prefix" class="form-control">
                </div>
                <div class="form-group col-8">
                  <label for="inputName">Business Cellphone</label>
                  <div class="input-group mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-phone"></i></span>
                    </div>
                    <input type="text" class="form-control" id="profile_business_cellphone">
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="inputStatus">Sex</label>
                <select id="inputStatus" class="form-control custom-select">
                  <option id="male_option">Male</option>
                  <option id="female_option">Female</option>
                  <option id="others_option">Others</option>
                </select>
              </div>
            </div>
            <!-- /.card-body -->
          </div>
          <!-- /.card -->
        </div>
      </div>
      <div class="row">
        <div class="col-12">
					<button type="button" class="btn btn-success float-right" id="save_changes" data-toggle="modal" data-target="#modal-xl">
						Save Changes
					</button>
        </div>
      </div>
    </section>
    <!-- /.content -->
  </div>
	
	<div class="modal fade" id="modal-xl">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Confirm Edit</h4>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="show_changes">
					<p id="noEdit" style="display: none;">No Edit Found</p>
					<p id="name_change_notification">Name will be modified from <b id="oldName"></b> to <b id="newName"></b></p>
					<p id="surname_change_notification">Surname will be modified from <b id="oldSurname"></b> to <b id="newSurname"></b></p>
					<p id="username_change_notification">Username will be modified from <b id="oldUsername"></b> to <b id="newUsername"></b></p>
					<p id="email_change_notification" style="display: none;">Email will be modified from <b id="oldEmail"></b> to <b id="newEmail"></b></p>
				</div>
				<div class="modal-footer justify-content-between">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" id="save_changes_confirm">Save changes</button>
				</div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal-dialog -->
	</div>
  <!-- /.content-wrapper -->

  <div id="footer_container">
  </div>
</div>
<!-- ./wrapper -->

<!-- jQuery -->
<script src="../../plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- InputMask -->
<script src="../../plugins/moment/moment.min.js"></script>
<script src="../../plugins/inputmask/jquery.inputmask.min.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.js"></script>

<script>
  $(document).ready(function(){
    $("#sidebar_container").load("sidebar_CA.html");
    $("#navbar_container").load("navbar_CA.html");
    $("#footer_container").load("footer.html");
    
    const NumberOfRequestBeforeReady = 1;
    var NumberOfRequest = 0; 
    
    var intervalId = setInterval(function() {
        if (NumberOfRequest == NumberOfRequestBeforeReady) {
            // console.log(NumberOfRequest);
            $(".preloader").css('height', 0);
            $(".preloader").children().hide();
        }
    }, 200);

    //Datemask dd/mm/yyyy
    $('#profile_birthday').inputmask('dd/mm/yyyy', { 'placeholder': 'dd/mm/yyyy' })

    var userInformation = new Array();
    const expected_param = [
      "name",
      "surname",
      "username",
      "email",
		  "birthdate",
		  "business_email",
		  "city",
		  "country",
		  "sex",
		  "street",
      "number",
		  "telephone",
		  "telephone_prefix",
		  "zip"
    ];
    const text_field = {
      "profile_name"      : "name",
      "profile_surname"   : "surname",
      "profile_username"  : "username",
      "profile_email"     : "email",
		  "profile_birthday"  : "birthdate",
		  "profile_business_email" : "business_email",
		  "profile_city"      : "city",
		  "profile_country"   : "country",
		  "profile_street"    : "street",
		  "profile_street_number" : "number",
		  "profile_business_cellphone" : "telephone",
		  "profile_cellphone_prefix" : "telephone_prefix",
		  "profile_zip"       : "zip"
    };
    const select_input = {
      "sex" : "#profile_sex option:selected" 
    }
    const sex_to_element_id = {
      "Male"    : "#male_option",
      "Female"  : "#female_option",
      "Others"  : "#others_option",
    }

    $.post("get_info.php", 
    { 
      info_id: "3",
      id: 0
    },
    
    function(data, status, xhr) {
      obj = JSON.parse(data);
      if (xhr.status == 200) {
        if (obj.data) {
          expected_param.forEach((value) => {
            if(obj.data[value] == null) {
              alert("An error occurred. Field "+value+" is missing.");
            } else {
              userInformation[value] = obj.data[value];
              $.each(text_field, function (key1, value1) {
                $("#"+key1).val(obj.data[value1]);
              });
            }
          });
          
          $(sex_to_element_id[obj.data["sex"]]).attr('selected', '');
        }
        NumberOfRequest++;
      } else {
        alert("Error 1");
      }
    });
      
    $("#save_changes").click(function(){
			var changed = 0;
			if (userInformation["name"] != $("#profile_name").val()) {
				if (changed == 0) {
					$("#noEdit").hide();
					$("#save_changes_confirm").removeAttr('disabled');
					changed = 1;
				}
				$("#name_change_notification").show();
				$("#oldName").text(userInformation["name"]);
				$("#newName").text($("#profile_name").val());
			} else {
				$("#name_change_notification").hide();
			}
			if (userInformation["surname"] != $("#profile_surname").val()) {
				if (changed == 0) {
					$("#noEdit").hide();
					$("#save_changes_confirm").removeAttr('disabled');
					changed = 1;
				}
				$("#surname_change_notification").show();
				$("#oldSurname").text(userInformation["surname"]);
				$("#newSurname").text($("#profile_surname").val());
			} else {
				$("#surname_change_notification").hide();
			}
			if (userInformation["username"] != $("#profile_username").val()) {
				if (changed == 0) {
							$("#noEdit").hide();
							$("#save_changes_confirm").removeAttr('disabled');
							changed = 1;
						}
						$("#username_change_notification").show();
						$("#oldUsername").text(userInformation["username"]);
						$("#newUsername").text($("#profile_username").val());
					} else {
						$("#username_change_notification").hide();
					}
					if (userInformation["email"] != $("#profile_email").val()) {
						if (changed == 0) {
							$("#noEdit").hide();
							$("#save_changes_confirm").removeAttr('disabled');
							changed = 1;
						}
						$("#email_change_notification").show();
						$("#oldEmail").text(userInformation["email"]);
						$("#newEmail").text($("#profile_email").val());
					} else {
						$("#email_change_notification").hide();
					}

					if (changed == 0) {
						$("#noEdit").show();
						$("#save_changes_confirm").attr('disabled', '');
					}
       	});

				$("#save_changes_confirm").click(function(){
					var changed = 0;
					var data = {};
					if (userInformation["name"] != $("#profile_name").val()) {
						changed = 1;
						data["name"] = $("#profile_name").val();
					} else {
						delete data["name"];
					}
					if (userInformation["surname"] != $("#profile_surname").val()) {
						changed = 1;
						data["surname"] = $("#profile_surname").val();
					} else {
						delete data["surname"];
					}
					if (userInformation["username"] != $("#profile_username").val()) {
						changed = 1;
						data["username"] = $("#profile_username").val();
					} else{
						delete data["username"];
					}
					if (userInformation["email"] != $("#profile_email").val()) {
						changed = 1;
						data["email"] = $("#profile_email").val();
					} else {
						delete data["email"];
					}
           if (userInformation["role"] != $("#inputStatus option:selected").text()) {
						changed = 1;
						data["role"] = $("#inputStatus option:selected").text();
					} else {
						delete data["role"];
					}

					if (changed == 0) {
						alert("This should not happen");
					} else {
             $("#save_changes_confirm").attr('disabled', '');
						$.post("set_info.php", 
         		{ 
           		set_function: "0",
							id: $.urlParam('id'),
           		data: JSON.stringify(data) 
         		},
         
         		function(data, status) {
               obj = JSON.parse(data);
               // if (obj.status == 200) {
                 if (obj.code == 41) {
                   alert("Something went wrong");
                 } else if (obj.code == 42) {
                   location.reload();
                 } else {
                   alert("Something went wrong (others)");
                 }
               // }
             });
					}
       	});
  });
</script>
</body>
</html>
